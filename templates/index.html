<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>{{ title }}</h1>
    <form method="POST">
        <label for="timezones">Select Timezones:</label>
        <select name="timezones" id="timezones" multiple>
            {% for tz in all_timezones %}
                <option value="{{ tz }}" {% if tz in selected_timezones %}selected{% endif %}>{{ tz }}</option>
            {% endfor %}
        </select>
        <button type="submit">Update Timezones</button>
    </form>
    <div id="clocks">
        {% for tz, data in times.items() %}
            <div class="clock" id="{{ tz }}">
                <h2>{{ tz }}:</h2> 
                <h3 id="{{ tz }}-time">{{ '%02d' % data.hour }}:{{ '%02d' % data.minute }}:{{ '%02d' % data.seconds }}</h3>
                <p id="{{ tz }}-date">{{ data.date }}</p>
            </div>
        {% endfor %}
    </div>
    <footer>{{ footer }}</footer>
    <script>
        async function fetchCurrentTimes(selectedTimezones) {
            const response = await fetch('/timezones');
            const allTimes = await response.json();
            selectedTimezones.forEach(tz => {
                const timeElement = document.getElementById(`${tz}-time`);
                const dateElement = document.getElementById(`${tz}-date`);
                const currentTime = allTimes[tz];
                timeElement.textContent = `${String(currentTime.hour).padStart(2, '0')}:${String(currentTime.minute).padStart(2, '0')}:${String(currentTime.seconds).padStart(2, '0')}`;
                dateElement.textContent = currentTime.date;
            });
        }

        function updateTime(selectedTimezones) {
            const now = new Date();
            selectedTimezones.forEach(tz => {
                const timeElement = document.getElementById(`${tz}-time`);
                const dateElement = document.getElementById(`${tz}-date`);
                let [hour, minute, second] = timeElement.textContent.split(':').map(Number);
                second = now.getSeconds();
                minute = now.getMinutes();
                hour = now.getHours();
                timeElement.textContent = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:${String(second).padStart(2, '0')}`;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const selectedTimezones = {{ selected_timezones | tojson }};
            fetchCurrentTimes(selectedTimezones);
            setInterval(() => updateTime(selectedTimezones), 1000);
            setInterval(() => fetchCurrentTimes(selectedTimezones), 60000); // Sync every minute
        });
    </script>
</body>
</html>